<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FIUP Tool - 文件增量更新协议</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            gray: {
              950: '#0a0a0f',
              900: '#111118',
              800: '#1a1a24',
              700: '#2a2a38',
              600: '#3a3a4a',
              500: '#5a5a6a',
              400: '#8a8a9a',
              300: '#b0b0c0',
            }
          }
        }
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    pre, code, .font-mono { font-family: 'SF Mono', 'Fira Code', 'JetBrains Mono', Consolas, monospace; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #3a3a4a; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #5a5a6a; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useCallback, useMemo } = React;

    const Icons = {
      Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
      FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>,
      Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
      Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
      CheckCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
      XCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>,
      AlertTriangle: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
      Copy: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
      Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
      ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>,
      ChevronRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>,
      Code: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props?.size || 20} height={props?.size || 20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>,
      RefreshCw: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
      Github: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>,
      Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
    };

    // FIUP v2.0 解析器
    const parseFIUP = (text) => {
      const pattern = /<<<FIUP_PATCH\s+file="([^"]+)">>>\s*\[OPERATION\]:\s*(REPLACE|INSERT_AFTER|INSERT_BEFORE|DELETE)\s*<<<ANCHOR>>>\n([\s\S]*?)<<<END_ANCHOR>>>\s*(?:<<<CONTENT>>>\n([\s\S]*?)<<<END_CONTENT>>>\s*)?<<<END_FIUP_PATCH>>>/g;
      
      const patches = [];
      let match;
      
      while ((match = pattern.exec(text)) !== null) {
        patches.push({
          id: crypto.randomUUID(),
          file: match[1],
          operation: match[2],
          anchor: match[3].replace(/\n$/, ''),
          content: match[4] ? match[4].replace(/\n$/, '') : '',
          raw: match[0]
        });
      }
      
      return patches;
    };

    const validatePatch = (patch) => {
      const errors = [];
      const warnings = [];
      
      if (!patch.file) errors.push('文件路径为空');
      if (!patch.anchor?.trim()) errors.push('锚点内容为空');
      
      const anchorLines = patch.anchor?.trim().split('\n').length || 0;
      if (anchorLines < 2) warnings.push(`锚点仅 ${anchorLines} 行，建议 3-6 行`);
      
      if (patch.operation !== 'DELETE' && !patch.content?.trim()) {
        errors.push('非 DELETE 操作但内容为空');
      }
      
      if (patch.anchor?.includes('...') || patch.anchor?.includes('# ...')) {
        warnings.push('锚点中包含 "..."，可能导致匹配失败');
      }
      
      return { valid: errors.length === 0, errors, warnings };
    };

    const simulateApply = (content, patch) => {
      const normalizedContent = content.replace(/\r\n/g, '\n');
      const normalizedAnchor = patch.anchor.replace(/\r\n/g, '\n');
      
      const pos = normalizedContent.indexOf(normalizedAnchor);
      if (pos === -1) {
        return { success: false, message: '锚点未找到', result: content };
      }
      
      const secondPos = normalizedContent.indexOf(normalizedAnchor, pos + 1);
      if (secondPos !== -1) {
        return { success: false, message: '锚点匹配到多处', result: content };
      }
      
      const before = normalizedContent.slice(0, pos);
      const after = normalizedContent.slice(pos + normalizedAnchor.length);
      let result;
      
      switch (patch.operation) {
        case 'REPLACE':
          result = before + patch.content + after;
          break;
        case 'INSERT_AFTER':
          const sep1 = normalizedAnchor.endsWith('\n') ? '' : '\n';
          result = before + normalizedAnchor + sep1 + patch.content + after;
          break;
        case 'INSERT_BEFORE':
          const sep2 = patch.content.endsWith('\n') ? '' : '\n';
          result = before + patch.content + sep2 + normalizedAnchor + after;
          break;
        case 'DELETE':
          result = before + after;
          break;
        default:
          result = content;
      }
      
      const line = before.split('\n').length;
      return { success: true, message: `精确匹配 @ 行 ${line}`, result, line };
    };

    const opColors = {
      REPLACE: { bg: 'bg-blue-500/10', text: 'text-blue-400', border: 'border-blue-500/30' },
      INSERT_AFTER: { bg: 'bg-green-500/10', text: 'text-green-400', border: 'border-green-500/30' },
      INSERT_BEFORE: { bg: 'bg-emerald-500/10', text: 'text-emerald-400', border: 'border-emerald-500/30' },
      DELETE: { bg: 'bg-red-500/10', text: 'text-red-400', border: 'border-red-500/30' }
    };

    const PatchCard = ({ patch, index, expanded, onToggle, onDelete, fileContent }) => {
      const validation = useMemo(() => validatePatch(patch), [patch]);
      const applyResult = useMemo(() => 
        fileContent ? simulateApply(fileContent, patch) : null
      , [fileContent, patch]);
      
      const color = opColors[patch.operation];
      
      return (
        <div className={`rounded-xl border ${color.border} ${color.bg} overflow-hidden transition-all duration-200`}>
          <div 
            className="flex items-center gap-3 p-4 cursor-pointer hover:bg-white/5 transition-colors"
            onClick={onToggle}
          >
            <div className="text-gray-500">
              {expanded ? <Icons.ChevronDown /> : <Icons.ChevronRight />}
            </div>
            
            <span className={`px-2 py-0.5 rounded text-xs font-mono font-medium ${color.text} ${color.bg} border ${color.border}`}>
              {patch.operation}
            </span>
            
            <span className="text-gray-300 font-mono text-sm flex-1 truncate">
              {patch.file}
            </span>
            
            <div className="flex items-center gap-2">
              {validation.warnings.length > 0 && (
                <span className="text-yellow-500"><Icons.AlertTriangle /></span>
              )}
              {applyResult?.success === true && (
                <span className="text-green-500"><Icons.CheckCircle /></span>
              )}
              {applyResult?.success === false && (
                <span className="text-red-500"><Icons.XCircle /></span>
              )}
              {!validation.valid && (
                <span className="text-red-500"><Icons.XCircle /></span>
              )}
            </div>
            
            <button 
              onClick={(e) => { e.stopPropagation(); onDelete(); }}
              className="p-1.5 rounded-lg hover:bg-red-500/20 text-gray-500 hover:text-red-400 transition-colors"
            >
              <Icons.Trash2 />
            </button>
          </div>
          
          {expanded && (
            <div className="px-4 pb-4 space-y-4">
              {(!validation.valid || validation.warnings.length > 0) && (
                <div className="space-y-1">
                  {validation.errors.map((err, i) => (
                    <div key={i} className="flex items-center gap-2 text-sm text-red-400">
                      <Icons.XCircle /> {err}
                    </div>
                  ))}
                  {validation.warnings.map((warn, i) => (
                    <div key={i} className="flex items-center gap-2 text-sm text-yellow-500">
                      <Icons.AlertTriangle /> {warn}
                    </div>
                  ))}
                </div>
              )}
              
              {applyResult && (
                <div className={`flex items-center gap-2 text-sm ${applyResult.success ? 'text-green-400' : 'text-red-400'}`}>
                  {applyResult.success ? <Icons.CheckCircle /> : <Icons.XCircle />}
                  {applyResult.message}
                </div>
              )}
              
              <div>
                <div className="text-xs text-gray-500 mb-1.5 font-medium">锚点 ANCHOR</div>
                <pre className="bg-black/30 rounded-lg p-3 text-sm text-gray-300 overflow-x-auto font-mono leading-relaxed whitespace-pre-wrap">
                  {patch.anchor}
                </pre>
              </div>
              
              {patch.content && (
                <div>
                  <div className="text-xs text-gray-500 mb-1.5 font-medium">内容 CONTENT</div>
                  <pre className="bg-black/30 rounded-lg p-3 text-sm text-green-300 overflow-x-auto font-mono leading-relaxed whitespace-pre-wrap">
                    {patch.content}
                  </pre>
                </div>
              )}
            </div>
          )}
        </div>
      );
    };

    const DiffView = ({ original, modified }) => {
      const diff = useMemo(() => {
        if (!original || !modified) return [];
        const oldLines = original.split('\n');
        const newLines = modified.split('\n');
        const result = [];
        
        let i = 0, j = 0;
        while (i < oldLines.length || j < newLines.length) {
          if (i < oldLines.length && j < newLines.length && oldLines[i] === newLines[j]) {
            result.push({ type: 'same', content: oldLines[i], lineOld: i + 1, lineNew: j + 1 });
            i++; j++;
          } else if (j < newLines.length && (i >= oldLines.length || !oldLines.includes(newLines[j]))) {
            result.push({ type: 'add', content: newLines[j], lineNew: j + 1 });
            j++;
          } else if (i < oldLines.length) {
            result.push({ type: 'del', content: oldLines[i], lineOld: i + 1 });
            i++;
          }
        }
        return result;
      }, [original, modified]);
      
      return (
        <div className="bg-gray-900/50 rounded-xl overflow-hidden border border-gray-700/50">
          <div className="overflow-x-auto max-h-96">
            <pre className="text-sm font-mono">
              {diff.map((line, idx) => (
                <div 
                  key={idx}
                  className={`px-4 py-0.5 flex ${
                    line.type === 'add' ? 'bg-green-500/10 text-green-300' :
                    line.type === 'del' ? 'bg-red-500/10 text-red-300' :
                    'text-gray-400'
                  }`}
                >
                  <span className="w-12 text-gray-600 select-none text-right pr-2">
                    {line.lineOld || ''}
                  </span>
                  <span className="w-12 text-gray-600 select-none text-right pr-2">
                    {line.lineNew || ''}
                  </span>
                  <span className="w-6 select-none">
                    {line.type === 'add' ? '+' : line.type === 'del' ? '-' : ' '}
                  </span>
                  <span className="flex-1 whitespace-pre">{line.content}</span>
                </div>
              ))}
            </pre>
          </div>
        </div>
      );
    };

    const Toast = ({ message, type, onClose }) => {
      React.useEffect(() => {
        const timer = setTimeout(onClose, 3000);
        return () => clearTimeout(timer);
      }, [onClose]);

      const colors = {
        success: 'bg-green-500/20 border-green-500/50 text-green-300',
        error: 'bg-red-500/20 border-red-500/50 text-red-300',
        info: 'bg-blue-500/20 border-blue-500/50 text-blue-300'
      };

      return (
        <div className={`fixed bottom-4 right-4 px-4 py-3 rounded-lg border ${colors[type]} animate-pulse`}>
          {message}
        </div>
      );
    };

    function FIUPApp() {
      const [patchText, setPatchText] = useState('');
      const [patches, setPatches] = useState([]);
      const [files, setFiles] = useState({});
      const [expandedPatch, setExpandedPatch] = useState(null);
      const [activeTab, setActiveTab] = useState('input');
      const [previewFile, setPreviewFile] = useState(null);
      const [toast, setToast] = useState(null);
      const [isDragging, setIsDragging] = useState(false);
      
      const showToast = (message, type = 'info') => {
        setToast({ message, type });
      };
      
      const handleParse = useCallback(() => {
        const parsed = parseFIUP(patchText);
        setPatches(parsed);
        if (parsed.length > 0) {
          setExpandedPatch(parsed[0].id);
          setActiveTab('patches');
          showToast(`成功解析 ${parsed.length} 个补丁`, 'success');
        } else {
          showToast('未找到有效的 FIUP 补丁', 'error');
        }
      }, [patchText]);
      
      const handleFileUpload = useCallback((e) => {
        const uploadedFiles = Array.from(e.target.files);
        if (uploadedFiles.length === 0) return;
        uploadedFiles.forEach(file => {
          const reader = new FileReader();
          reader.onload = (event) => {
            const content = event.target.result;
            setFiles(prev => ({ ...prev, [file.name]: content }));
            setPreviewFile(prev => {
              if (prev && prev.name === file.name) {
                return { ...prev, original: content, needsRefresh: true };
              }
              return prev;
            });
            showToast(`已加载文件: ${file.name}`, 'success');
          };
          reader.readAsText(file);
        });
        e.target.value = '';
      }, []);

      const handleDragOver = useCallback((e) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragging(true);
      }, []);

      const handleDragLeave = useCallback((e) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragging(false);
      }, []);

      const handleDrop = useCallback((e) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragging(false);
        
        const droppedFiles = Array.from(e.dataTransfer.files);
        if (droppedFiles.length === 0) return;
        
        droppedFiles.forEach(file => {
          const reader = new FileReader();
          reader.onload = (event) => {
            const content = event.target.result;
            setFiles(prev => ({ ...prev, [file.name]: content }));
            setPreviewFile(prev => {
              if (prev && prev.name === file.name) {
                return { ...prev, original: content, needsRefresh: true };
              }
              return prev;
            });
          };
          reader.readAsText(file);
        });
        showToast(`已加载 ${droppedFiles.length} 个文件`, 'success');
      }, []);

      const handleDeleteFile = useCallback((fileName) => {
        setFiles(prev => {
          const newFiles = { ...prev };
          delete newFiles[fileName];
          return newFiles;
        });
        if (previewFile?.name === fileName) {
          setPreviewFile(null);
        }
        showToast(`已移除文件: ${fileName}`, 'info');
      }, [previewFile]);
      
      const handleDeletePatch = useCallback((id) => {
        setPatches(prev => prev.filter(p => p.id !== id));
      }, []);
      
      const handlePreview = useCallback((fileName) => {
        const filePatches = patches.filter(p => p.file === fileName || p.file.endsWith('/' + fileName));
        const originalContent = files[fileName] || '';
        let content = originalContent;
        
        for (const patch of filePatches) {
          const result = simulateApply(content, patch);
          if (result.success) {
            content = result.result;
          }
        }
        
        setPreviewFile({ name: fileName, original: originalContent, modified: content, needsRefresh: false });
      }, [patches, files]);

      React.useEffect(() => {
        if (previewFile?.needsRefresh && previewFile.name) {
          handlePreview(previewFile.name);
        }
      }, [previewFile?.needsRefresh, previewFile?.name, handlePreview]);

      const handleApplyAndDownload = useCallback((fileName) => {
        const filePatches = patches.filter(p => p.file === fileName || p.file.endsWith('/' + fileName));
        const originalContent = files[fileName] || files[Object.keys(files).find(f => fileName.endsWith(f))] || '';
        
        if (!originalContent) {
          showToast(`请先上传文件: ${fileName}`, 'error');
          return;
        }
        
        let content = originalContent;
        let successCount = 0;
        
        for (const patch of filePatches) {
          const result = simulateApply(content, patch);
          if (result.success) {
            content = result.result;
            successCount++;
          }
        }
        
        if (successCount === 0) {
          showToast('没有成功应用的补丁', 'error');
          return;
        }
        
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName.split('/').pop();
        a.click();
        URL.revokeObjectURL(url);
        showToast(`已导出: ${fileName} (${successCount}/${filePatches.length} 补丁成功)`, 'success');
      }, [patches, files]);
      
      const handleCopyPatches = useCallback(() => {
        const text = patches.map(p => p.raw).join('\n\n');
        navigator.clipboard.writeText(text);
        showToast('已复制到剪贴板', 'success');
      }, [patches]);

      const handleExport = useCallback(() => {
        if (!previewFile) return;
        const blob = new Blob([previewFile.modified], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = previewFile.name;
        a.click();
        URL.revokeObjectURL(url);
        showToast(`已导出: ${previewFile.name}`, 'success');
      }, [previewFile]);
      
      const stats = useMemo(() => {
        const byOp = { REPLACE: 0, INSERT_AFTER: 0, INSERT_BEFORE: 0, DELETE: 0 };
        const byFile = {};
        patches.forEach(p => {
          byOp[p.operation]++;
          byFile[p.file] = (byFile[p.file] || 0) + 1;
        });
        return { byOp, byFile, total: patches.length };
      }, [patches]);

      return (
        <div 
          className={`min-h-screen bg-gradient-to-br from-gray-950 via-gray-900 to-gray-950 text-white transition-colors ${isDragging ? 'ring-2 ring-inset ring-violet-500' : ''}`}
          onDragOver={handleDragOver}
          onDragLeave={handleDragLeave}
          onDrop={handleDrop}
        >
          {isDragging && (
            <div className="fixed inset-0 bg-violet-500/10 backdrop-blur-sm z-50 flex items-center justify-center pointer-events-none">
              <div className="bg-gray-900/90 border-2 border-dashed border-violet-500 rounded-2xl p-12 text-center">
                <div className="text-violet-400 mb-4">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mx-auto"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                </div>
                <p className="text-xl font-medium text-white">释放文件以上传</p>
                <p className="text-gray-400 text-sm mt-2">支持多文件同时上传</p>
              </div>
            </div>
          )}

          <header className="border-b border-gray-800/50 backdrop-blur-sm bg-gray-900/30 sticky top-0 z-10">
            <div className="max-w-6xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-500 to-fuchsia-500 flex items-center justify-center">
                  <Icons.Code />
                </div>
                <div>
                  <h1 className="text-lg font-semibold">FIUP Tool</h1>
                  <p className="text-xs text-gray-500 hidden sm:block">文件增量更新协议 FIUP 在线工具 v2.0</p>
                </div>
              </div>
              
              <div className="flex items-center gap-3">
                <a 
                  href="https://github.com/Thankyou-Cheems/FIUP" 
                  target="_blank"
                  className="p-2 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-white transition-colors"
                  title="GitHub 仓库"
                >
                  <Icons.Github />
                </a>
              </div>
            </div>
          </header>
          
          <main className="max-w-7xl mx-auto px-4 sm:px-6 py-6 sm:py-8">
            <div className="flex flex-col lg:flex-row gap-6">
              <div className="lg:w-72 xl:w-80 flex-shrink-0">
                <div className="lg:sticky lg:top-24 space-y-4">
                  <div 
                    className={`p-4 rounded-xl border-2 border-dashed transition-all cursor-pointer ${
                      isDragging 
                        ? 'border-violet-500 bg-violet-500/10' 
                        : 'border-gray-700 hover:border-gray-600 bg-gray-800/30'
                    }`}
                    onClick={() => document.getElementById('file-input').click()}
                  >
                    <div className="text-center py-4">
                      <div className={`mx-auto w-12 h-12 rounded-xl flex items-center justify-center mb-3 ${
                        isDragging ? 'bg-violet-500/20 text-violet-400' : 'bg-gray-800 text-gray-500'
                      }`}>
                        <Icons.Upload />
                      </div>
                      <p className="text-sm font-medium text-gray-300">
                        {isDragging ? '释放以上传' : '拖拽或点击上传'}
                      </p>
                      <p className="text-xs text-gray-500 mt-1">支持多文件</p>
                    </div>
                    <input 
                      id="file-input"
                      type="file" 
                      multiple 
                      className="hidden" 
                      onChange={handleFileUpload} 
                      accept=".py,.pyw,.pyi,.pyx,.js,.mjs,.cjs,.ts,.mts,.cts,.jsx,.tsx,.json,.jsonc,.md,.mdx,.txt,.html,.htm,.css,.scss,.less,.yaml,.yml,.toml,.ini,.cfg,.conf,.xml,.vue,.svelte,.go,.rs,.java,.kt,.kts,.c,.cpp,.h,.hpp,.cs,.php,.rb,.sh,.bash,.zsh,.ps1,.bat,.cmd,.sql,.graphql,.proto,.env,.gitignore,.dockerignore" 
                    />
                  </div>

                  <div className="bg-gray-800/30 rounded-xl border border-gray-700/50 overflow-hidden">
                    <div className="flex items-center justify-between px-4 py-3 border-b border-gray-700/50">
                      <h3 className="text-sm font-medium text-gray-300">
                        源文件 ({Object.keys(files).length})
                      </h3>
                      {Object.keys(files).length > 0 && (
                        <button
                          onClick={() => { setFiles({}); setPreviewFile(null); showToast('已清空所有文件', 'info'); }}
                          className="text-xs text-gray-500 hover:text-red-400 transition-colors"
                        >
                          清空
                        </button>
                      )}
                    </div>
                    
                    <div className="max-h-64 lg:max-h-96 overflow-y-auto">
                      {Object.keys(files).length === 0 ? (
                        <div className="px-4 py-8 text-center text-gray-600 text-sm">
                          暂无文件
                        </div>
                      ) : (
                        <div className="p-2 space-y-1">
                          {Object.entries(files).map(([name, content]) => {
                            const patchCount = patches.filter(p => 
                              p.file === name || p.file.endsWith('/' + name)
                            ).length;
                            const lines = content.split('\n').length;
                            const size = new Blob([content]).size;
                            const sizeStr = size < 1024 ? `${size} B` : `${(size / 1024).toFixed(1)} KB`;
                            
                            return (
                              <div 
                                key={name}
                                className="flex items-center gap-2 p-2 rounded-lg group hover:bg-gray-700/30 transition-colors"
                              >
                                <div className="w-7 h-7 rounded bg-gray-800 flex items-center justify-center text-gray-500 flex-shrink-0">
                                  <Icons.FileText />
                                </div>
                                <div className="flex-1 min-w-0">
                                  <div className="text-xs text-gray-300 truncate font-mono" title={name}>{name}</div>
                                  <div className="text-xs text-gray-600">{lines} 行 · {sizeStr}</div>
                                </div>
                                {patchCount > 0 && (
                                  <span className="px-1.5 py-0.5 rounded bg-violet-500/20 text-violet-400 text-xs flex-shrink-0">
                                    {patchCount}
                                  </span>
                                )}
                                <button
                                  onClick={() => handleDeleteFile(name)}
                                  className="p-1 rounded opacity-0 group-hover:opacity-100 hover:bg-red-500/20 text-gray-500 hover:text-red-400 transition-all flex-shrink-0"
                                  title="移除文件"
                                >
                                  <Icons.Trash2 />
                                </button>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                  </div>

                  {patches.length > 0 && Object.keys(files).length > 0 && (
                    <div className="bg-gradient-to-br from-violet-500/10 to-fuchsia-500/10 rounded-xl border border-violet-500/20 p-3">
                      <div className="text-xs font-medium text-gray-400 mb-2">一键应用并下载</div>
                      <div className="space-y-1">
                        {[...new Set(patches.map(p => p.file))].map(fileName => {
                          const shortName = fileName.split('/').pop();
                          const hasFile = Object.keys(files).some(f => fileName === f || fileName.endsWith('/' + f));
                          if (!hasFile) return null;
                          return (
                            <button
                              key={fileName}
                              onClick={() => handleApplyAndDownload(fileName)}
                              className="w-full flex items-center gap-2 px-3 py-2 rounded-lg bg-violet-500/20 hover:bg-violet-500/30 text-violet-300 text-sm font-medium transition-all text-left"
                            >
                              <Icons.Download />
                              <span className="truncate">{shortName}</span>
                            </button>
                          );
                        })}
                      </div>
                    </div>
                  )}
                </div>
              </div>

              <div className="flex-1 min-w-0">
                <div className="flex gap-1 p-1 bg-gray-800/50 rounded-xl mb-6 w-fit overflow-x-auto">
                  {[
                    { id: 'input', label: '输入补丁', icon: Icons.FileText },
                    { id: 'patches', label: `补丁列表 (${stats.total})`, icon: Icons.Code },
                    { id: 'preview', label: '预览变更', icon: Icons.Eye }
                  ].map(tab => (
                    <button
                      key={tab.id}
                      onClick={() => setActiveTab(tab.id)}
                      className={`flex items-center gap-2 px-3 sm:px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap ${
                        activeTab === tab.id 
                          ? 'bg-violet-500 text-white' 
                          : 'text-gray-400 hover:text-white hover:bg-gray-700/50'
                      }`}
                    >
                      <tab.icon />
                      <span className="hidden sm:inline">{tab.label}</span>
                      <span className="sm:hidden">{tab.id === 'patches' ? stats.total : ''}</span>
                    </button>
                  ))}
                </div>
            
            {activeTab === 'input' && (
              <div className="space-y-4">
                <div className="flex items-center justify-between flex-wrap gap-4">
                  <h2 className="text-lg font-medium">输入 FIUP 补丁</h2>
                  <button
                    onClick={handleParse}
                    disabled={!patchText.trim()}
                    className="flex items-center gap-2 px-4 py-2 rounded-lg bg-violet-500 hover:bg-violet-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium"
                  >
                    <Icons.Play />
                    解析补丁
                  </button>
                </div>
                
                <textarea
                  value={patchText}
                  onChange={(e) => setPatchText(e.target.value)}
                  placeholder={`粘贴 FIUP 补丁内容...

示例格式:
<<<FIUP_PATCH file="example.py">>>
[OPERATION]: REPLACE

<<<ANCHOR>>>
def old_function():
    pass
<<<END_ANCHOR>>>

<<<CONTENT>>>
def new_function():
    return "Hello"
<<<END_CONTENT>>>
<<<END_FIUP_PATCH>>>`}
                  className="w-full h-80 sm:h-96 bg-gray-900/50 border border-gray-700/50 rounded-xl p-4 font-mono text-sm text-gray-300 placeholder-gray-600 focus:outline-none focus:border-violet-500/50 focus:ring-1 focus:ring-violet-500/20 resize-none"
                />
                
                <div className="flex items-center gap-4 text-sm text-gray-500 flex-wrap">
                  <span>✓ 从 AI 对话粘贴</span>
                  <span>✓ 自动识别多补丁</span>
                  <span>✓ 拖拽文件到页面任意位置上传</span>
                </div>
              </div>
            )}
            
            {activeTab === 'patches' && (
              <div className="space-y-4">
                {stats.total > 0 && (
                  <div className="flex items-center gap-4 p-4 bg-gray-800/30 rounded-xl flex-wrap">
                    <div className="flex items-center gap-4 sm:gap-6 flex-1 flex-wrap">
                      {Object.entries(stats.byOp).map(([op, count]) => count > 0 && (
                        <div key={op} className="flex items-center gap-2">
                          <span className={`w-2 h-2 rounded-full ${opColors[op].text.replace('text-', 'bg-')}`} />
                          <span className="text-sm text-gray-400">{op}</span>
                          <span className="text-sm font-medium">{count}</span>
                        </div>
                      ))}
                    </div>
                    <button
                      onClick={handleCopyPatches}
                      className="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-gray-700 hover:bg-gray-600 text-sm transition-colors"
                    >
                      <Icons.Copy />
                      复制全部
                    </button>
                  </div>
                )}
                
                <div className="space-y-3">
                  {patches.length === 0 ? (
                    <div className="text-center py-16 text-gray-500">
                      <div className="mx-auto mb-4 opacity-30"><Icons.Code size={48} /></div>
                      <p>暂无补丁</p>
                      <p className="text-sm mt-1">在"输入补丁"标签页粘贴 FIUP 内容</p>
                    </div>
                  ) : (
                    patches.map((patch, index) => (
                      <PatchCard
                        key={patch.id}
                        patch={patch}
                        index={index}
                        expanded={expandedPatch === patch.id}
                        onToggle={() => setExpandedPatch(expandedPatch === patch.id ? null : patch.id)}
                        onDelete={() => handleDeletePatch(patch.id)}
                        fileContent={files[patch.file] || files[patch.file.split('/').pop()]}
                      />
                    ))
                  )}
                </div>
              </div>
            )}
            
            {activeTab === 'preview' && (
              <div className="space-y-4">
                <div className="flex items-center gap-4 flex-wrap">
                  <h2 className="text-lg font-medium">选择文件预览</h2>
                  {previewFile && (
                    <button
                      onClick={handleExport}
                      className="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-green-500/20 hover:bg-green-500/30 text-green-400 text-sm transition-colors ml-auto"
                    >
                      <Icons.Download />
                      导出文件
                    </button>
                  )}
                </div>
                
                <div className="flex flex-wrap gap-2">
                  {Object.keys(files).length === 0 ? (
                    <div className="w-full text-center py-8 border-2 border-dashed border-gray-700 rounded-xl">
                      <p className="text-gray-400">请先在左侧上传源文件</p>
                      <p className="text-gray-600 text-sm mt-1">支持拖拽到页面任意位置</p>
                    </div>
                  ) : (
                    Object.keys(files).map(name => {
                      const patchCount = patches.filter(p => 
                        p.file === name || p.file.endsWith('/' + name)
                      ).length;
                      return (
                        <button
                          key={name}
                          onClick={() => handlePreview(name)}
                          className={`flex items-center gap-2 px-4 py-2 rounded-lg border transition-colors ${
                            previewFile?.name === name
                              ? 'bg-violet-500/20 border-violet-500/50 text-violet-300'
                              : 'bg-gray-800/50 border-gray-700/50 hover:border-gray-600'
                          }`}
                        >
                          <Icons.FileText />
                          <span className="text-sm">{name}</span>
                          {patchCount > 0 && (
                            <span className="px-1.5 py-0.5 rounded bg-violet-500/30 text-xs">
                              {patchCount}
                            </span>
                          )}
                        </button>
                      );
                    })
                  )}
                </div>
                
                {previewFile && (
                  <div className="space-y-2">
                    <div className="flex items-center justify-between">
                      <h3 className="text-sm font-medium text-gray-400">
                        变更预览: {previewFile.name}
                      </h3>
                      <button
                        onClick={() => handlePreview(previewFile.name)}
                        className="flex items-center gap-1.5 px-2 py-1 rounded text-xs text-gray-400 hover:text-white transition-colors"
                      >
                        <Icons.RefreshCw />
                        刷新
                      </button>
                    </div>
                    <DiffView original={previewFile.original} modified={previewFile.modified} />
                  </div>
                )}
              </div>
            )}
              </div>
            </div>
          </main>
          
          <footer className="border-t border-gray-800/50 mt-auto">
            <div className="max-w-6xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between text-sm text-gray-500 flex-wrap gap-2">
              <span>FIUP Tool UI v2.0</span>
              <span className="hidden sm:inline">基于文本锚点的代码修改协议</span>
              <a href="https://github.com/Thankyou-Cheems" target="_blank" className="hover:text-gray-300 transition-colors">猹Cheems</a>
            </div>
          </footer>

          {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<FIUPApp />);
  </script>
</body>
</html>
